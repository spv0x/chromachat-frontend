<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chromachat - real-time (modal css fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script> 
    <style>
        :root {
            --accent-color: #4caf50; --accent-color-dark: #388e3c;
            --text-primary: #212121; --text-secondary: #757575;
            --bg-light: #f5f5f5; --bg-default: #ffffff; --divider-color: #e0e0e0;
        }
        body {
            font-family: 'Roboto', 'Noto Color Emoji', sans-serif;
            background-color: var(--bg-light); color: var(--text-primary);
            overscroll-behavior-y: contain; text-transform: lowercase;
            display: flex; flex-direction: column; height: 100vh;
        }
        #messageInput, .message-bubble p, #emojiSearchInput { text-transform: none; }
        .material-icons, .material-icons-outlined { vertical-align: middle; }
        .bg-accent { background-color: var(--accent-color); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        .ring-accent:focus { ring-color: var(--accent-color); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-light); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9e9e9e; }

        .ripple {
            background-position: center;
            transition: background 0.5s, transform 0.2s ease-out;
        }
        .ripple:hover {
            background: var(--accent-color-dark) radial-gradient(circle, transparent 1%, var(--accent-color-dark) 1%) center/15000%;
            transform: scale(1.03);
        }
        .ripple:active {
            background-color: #66bb6a; background-size: 100%;
            transform: scale(0.98); transition: background 0s, transform 0.1s;
        }
        
        .chat-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        .message-item {
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-out;
        }
        .message-item.sent-animation { transform: translateX(100px); opacity: 0; }
        .message-item.received-animation { transform: translateX(-100px); opacity: 0; }
        .message-item.system-animation { transform: scale(0.9); opacity: 0; }
        .message-item.show { transform: translateX(0) scale(1); opacity: 1; }


        .message-bubble { max-width: 75%; }
        .message-bubble.sent {
            background-color: var(--accent-color); color: white;
            margin-left: auto; border-radius: 20px 20px 5px 20px;
        }
        .message-bubble.received { 
            background-color: var(--bg-default); color: var(--text-primary);
            margin-right: auto; border-radius: 20px 20px 20px 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message-bubble.system {
            background-color: transparent; color: var(--text-secondary);
            font-size: 0.8rem; font-style: italic; text-align: center;
            width: 100%; max-width: 100%; padding: 4px 0;
            box-shadow: none;
        }
        .message-avatar {
            width: 32px; height: 32px; min-width: 32px;
            border-radius: 50%; object-fit: cover;
            border: 2px solid var(--bg-default);
            transition: transform 0.3s ease;
        }
        .message-image {
            max-width: 100%; max-height: 250px;
            border-radius: 10px; margin-top: 8px; cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .message-image:hover { transform: scale(1.05); }

        /* Modal Animation CSS */
        .modal-bg-enter { opacity: 0; }
        .modal-bg-enter-active { opacity: 0.75; transition: opacity 300ms ease-out; }
        .modal-bg-leave-active { opacity: 0; transition: opacity 200ms ease-in; }
        
        .modal-content-enter { opacity: 0; transform: scale(0.9) translateY(20px); }
        .modal-content-enter-active { opacity: 1; transform: scale(1) translateY(0); transition: opacity 300ms ease-out, transform 300ms cubic-bezier(0.25, 0.8, 0.25, 1); }
        .modal-content-leave-active { opacity: 0; transform: scale(0.9); transition: opacity 200ms ease-in, transform 200ms ease-in; }

        #imagePreviewModal { background-color: transparent; } /* Backdrop is separate */
        #imagePreviewModal img { 
            max-height: 90vh; max-width: 90vw; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 8px; text-transform: none;
            /* Animation classes for image preview modal are similar to userSetupModal */
        }
        
        .file-input-button {
            background-color: var(--accent-color); color: white;
            padding: 0.5rem 1rem; border-radius: 0.375rem; 
            cursor: pointer; transition: background-color 0.2s, transform 0.2s ease-out;
        }
        .file-input-button:hover { background-color: var(--accent-color-dark); transform: scale(1.03); }

        .loader {
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block; vertical-align: middle;
        }
        .button-loader { border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; }
        .attach-loader { border: 2px solid var(--accent-color); border-top-color: transparent; width:18px; height:18px; margin-left: 5px;}


        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .dark {
            --text-primary: #f3f4f6; --text-secondary: #9ca3af; 
            --bg-light: #1f2937; --bg-default: #374151; --divider-color: #4b5563; 
        }
        .dark ::-webkit-scrollbar-track { background: var(--bg-default); }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .dark .message-avatar { border-color: var(--bg-light); }
        
        #connectionStatus {
            padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;
            position: fixed; top: 10px; right: 10px; z-index: 1000; text-transform: uppercase; 
            opacity: 0; transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        #connectionStatus.visible { opacity: 1; transform: translateY(0); }
        #connectionStatus.connected { background-color: var(--accent-color); color: white; }
        #connectionStatus.disconnected { background-color: #ef4444; color: white; }
        #connectionStatus.connecting { background-color: #eab308; color: #422006; }

        #chatAppContainer { display: flex; flex: 1; overflow: hidden; }
        #chatApp > header { transform: translateY(-100%); transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #chatApp > footer { transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #chatApp.app-loaded > header, #chatApp.app-loaded > footer { transform: translateY(0); }

        #profilePicPreview { transition: opacity 0.4s ease-in-out, transform 0.3s ease; }
        #profilePicPreview.loading { opacity: 0.5; transform: scale(0.95); }

        #themeToggleButton, #attachFileButtonWrapper > button, #sendMessageButton > span.material-icons, #emojiButton {
            transition: transform 0.2s ease-out;
        }
        #themeToggleButton:hover, #attachFileButtonWrapper > button:hover, 
        #sendMessageButton:hover > span.material-icons, #emojiButton:hover {
            transform: scale(1.15);
        }

        #userListSidebar {
            width: 0; min-width: 0; background-color: var(--bg-default);
            border-right: 1px solid var(--divider-color);
            transition: min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 0; overflow: hidden; 
        }
        #userListSidebar.open { min-width: 240px; opacity: 1; }
        .user-list-item { transition: background-color 0.2s ease-in-out; }
        .user-list-item:hover { background-color: var(--bg-light); }
        .online-dot { width: 8px; height: 8px; background-color: var(--accent-color); border-radius: 50%; border: 1.5px solid var(--bg-default); }
        .typing-text { font-size: 0.7rem; font-style: italic; color: var(--text-secondary); }

        #emojiPicker {
            position: absolute; bottom: 65px; left: 10px; width: 300px; max-height: 250px;
            background-color: var(--bg-default); border: 1px solid var(--divider-color);
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100; overflow-y: auto; padding: 8px;
            opacity: 0; transform: translateY(10px) scale(0.95);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
        }
        #emojiPicker.visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .emoji-category { margin-bottom: 8px; }
        .emoji-category-title { font-size: 0.8rem; font-weight: 500; margin-bottom: 4px; color: var(--text-secondary); }
        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); gap: 4px; }
        .emoji-item {
            padding: 6px; font-size: 1.25rem; text-align: center;
            border-radius: 4px; cursor: pointer;
            transition: background-color 0.15s ease;
        }
        .emoji-item:hover { background-color: var(--bg-light); }
        #emojiSearchInput {
            width: calc(100% - 16px); margin: 0 8px 8px 8px; padding: 6px 10px;
            border-radius: 6px; border: 1px solid var(--divider-color);
            background-color: var(--bg-light);
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden"> 
    <div id="connectionStatus">disconnected</div>

    <!-- Initial User Setup Modal -->
    <div id="userSetupModal" class="fixed inset-0 flex items-center justify-center z-50 p-4">
        <!-- MODIFICATION: Removed initial opacity-0 from backdrop -->
        <div id="userSetupModalBackdrop" class="absolute inset-0 bg-gray-900"></div>
        <!-- MODIFICATION: Removed initial opacity-0 and scale-90 from content -->
        <div id="userSetupModalContent" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md transform">
            <div class="text-center">
                <span class="material-icons-outlined text-5xl text-accent mb-3">groups</span>
                <h2 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-gray-100">welcome to chromachat!</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-6">let's get you set up.</p>
            </div>
            <div class="space-y-5">
                <div>
                    <label for="usernameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">choose a nickname</label>
                    <div class="relative">
                        <span class="material-icons-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500">person_outline</span>
                        <input type="text" id="usernameInput" placeholder="e.g., chattycathy" class="w-full pl-10 pr-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 ring-accent focus:border-accent transition duration-150 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">profile picture (optional)</label>
                    <div class="flex items-center space-x-3">
                        <img id="profilePicPreview" src="https://placehold.co/80x80/374151/f3f4f6?text=avatar" alt="avatar preview" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600">
                        <label for="profilePicInput" class="file-input-button flex items-center space-x-2">
                            <span class="material-icons-outlined text-lg">upload_file</span>
                            <span>choose file</span>
                        </label>
                        <input type="file" id="profilePicInput" accept="image/png, image/jpeg, image/webp, image/gif" class="hidden" aria-label="profile picture file input">
                    </div>
                     <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">png, jpg, gif, webp. max 1mb.</p>
                </div>
            </div>
            <button id="joinChatButton" class="w-full bg-accent text-white py-3 mt-8 rounded-lg font-semibold ripple focus:outline-none focus:ring-2 focus:ring-offset-2 ring-accent transition duration-150 text-lg flex items-center justify-center space-x-2" aria-label="start chatting">
                <span class="material-icons-outlined default-icon">chat</span>
                <span class="button-text">start chatting</span>
                <div class="loader button-loader hidden"></div>
            </button>
            <p id="setupError" class="text-red-500 text-sm mt-3 text-center"></p>
        </div>
    </div>
    
    <div id="chatAppContainer" class="hidden flex-1">
        <aside id="userListSidebar" class="flex-col p-3 space-y-2 overflow-y-auto">
            <h3 class="text-lg font-semibold text-accent mb-2 sticky top-0 bg-inherit py-1">online users</h3>
            <div id="userList" class="space-y-1.5">
            </div>
        </aside>

        <main id="chatApp" class="flex flex-1 flex-col h-full overflow-hidden">
            <header class="bg-white dark:bg-gray-800 border-b border-divider-color dark:border-l dark:border-gray-700 p-3 sm:p-4 flex items-center justify-between shadow-sm">
                <div class="flex items-center">
                     <button id="toggleUserListButton" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none mr-2" aria-label="toggle user list">
                        <span class="material-icons-outlined text-gray-600 dark:text-gray-300">menu</span>
                    </button>
                    <h1 class="text-xl sm:text-2xl font-semibold text-accent flex items-center">
                        <span class="material-icons-outlined mr-2 text-3xl">forum</span>
                        chromachat
                    </h1>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="themeToggleButton" title="toggle theme" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none" aria-label="toggle theme">
                        <span class="material-icons-outlined text-gray-600 dark:text-gray-300">brightness_6</span>
                    </button>
                    <img id="currentUserAvatar" src="https://placehold.co/40x40/374151/f3f4f6?text=me" alt="my avatar" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover cursor-pointer border-2 border-accent">
                </div>
            </header>

            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900" aria-live="polite">
            </div>
            <div id="typingIndicatorArea" class="h-6 px-4 pb-1 text-sm text-gray-500 dark:text-gray-400 flex items-center">
            </div>

            <footer class="bg-white dark:bg-gray-800 border-t border-divider-color dark:border-l dark:border-gray-700 p-3 sm:p-4 relative">
                 <div id="emojiPicker" class="hidden">
                    <input type="text" id="emojiSearchInput" placeholder="search emojis..." class="focus:ring-accent focus:border-accent">
                    <div id="emojiGridContainer"></div>
                 </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <button id="emojiButton" title="emojis" class="p-2.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-500 dark:text-gray-400" aria-label="select emoji">
                        <span class="material-icons-outlined text-2xl">sentiment_satisfied</span>
                    </button>
                    <div id="attachFileButtonWrapper" class="relative">
                        <button id="attachFileButtonTrigger" title="attach image" class="p-2.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-accent" aria-label="attach image">
                            <span class="material-icons-outlined text-2xl">attach_file</span>
                        </button>
                        <div id="attachFileLoader" class="loader attach-loader absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden"></div>
                    </div>
                    <input type="file" id="imageFileInput" accept="image/png, image/jpeg, image/webp, image/gif" class="hidden" aria-label="image file input">
                    
                    <input type="text" id="messageInput" placeholder="type a message..." class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none chat-input transition duration-150 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" aria-label="message input">
                    
                    <button id="sendMessageButton" class="bg-accent text-white rounded-full p-3 ripple focus:outline-none focus:ring-2 focus:ring-offset-1 ring-accent transition duration-150" aria-label="send message">
                        <span class="material-icons text-2xl">send</span>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <div id="imagePreviewModal" class="fixed inset-0 flex items-center justify-center z-50 p-4 hidden">
        <div id="imagePreviewModalBackdrop" class="absolute inset-0 bg-black"></div> <!-- MODIFICATION: Removed opacity-0 here for testing -->
        <img id="fullScreenImage" src="" alt="full screen preview" class="max-w-full max-h-full rounded-lg shadow-xl z-10 transform"> <!-- MODIFICATION: Removed opacity-0 scale-90 here for testing -->
        <button id="closeImagePreviewButton" class="absolute top-4 right-4 text-white text-3xl z-20 p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75" aria-label="close image preview">
            <span class="material-icons">close</span>
        </button>
    </div>

    <script>
        // DOM Elements
        const userSetupModal = document.getElementById('userSetupModal');
        const userSetupModalBackdrop = document.getElementById('userSetupModalBackdrop');
        const userSetupModalContent = document.getElementById('userSetupModalContent');
        const usernameInput = document.getElementById('usernameInput');
        // ... (rest of DOM elements)

        // --- State ---
        let userProfile = { /* ... */ };
        let messages = []; 
        let tempImageFileDataUrl = null; 
        let socket = null; 
        const SERVER_URL = 'https://chromachat-server.onrender.com'; 
        // ... (rest of state variables)
        
        // --- Sound Initialization ---
        function initializeSounds() { /* ... */ }
        function playNotificationSound() { /* ... */ }

        // --- Notifications ---
        function requestNotificationPermission() { /* ... */ }
        function showNotification(title, body, icon) { /* ... */ }

        // --- Socket.IO Connection & Status ---
        function updateConnectionStatus(status, message = '') { /* ... */ }
        function connectToServer() { /* ... */ }
        
        // --- App Initialization (with DEBUG logs) ---
        function applyTheme(theme) { /* ... same as before with DEBUG logs ... */ }
        function initializeApp() { /* ... same as before with DEBUG logs ... */ }

        // --- User Profile & Setup ---
        async function handleJoinChat() { /* ... same as before ... */ }
        function resetJoinButton() { /* ... same as before ... */ }
        profilePicInput.addEventListener('change', async (e) => { /* ... same as before ... */ });
        joinChatButton.addEventListener('click', async () => { if (await handleJoinChat()) hideUserSetupModal(); });
        
        // --- Modal Visibility (with DEBUG logs) ---
        function showUserSetupModal(initial = false) {
            console.log("[DEBUG] showUserSetupModal called, initial:", initial); 
            if (!userSetupModal || !userSetupModalBackdrop || !userSetupModalContent || !chatAppContainer) {
                console.error("[DEBUG] CRITICAL: One or more modal/app elements not found in showUserSetupModal!");
                return; 
            }

            userSetupModal.classList.remove('hidden'); // This should make it part of the layout
            console.log("[DEBUG] userSetupModal 'hidden' class removed. Current classes:", userSetupModal.className); 

            // Forcing a reflow before adding animation classes can sometimes help.
            void userSetupModal.offsetWidth; 

            if (initial) { // Only apply enter animations on initial show
                userSetupModalBackdrop.classList.remove('modal-bg-leave-active');
                userSetupModalBackdrop.classList.add('modal-bg-enter', 'modal-bg-enter-active');
                
                userSetupModalContent.classList.remove('modal-content-leave-active');
                userSetupModalContent.classList.add('modal-content-enter', 'modal-content-enter-active');
                console.log("[DEBUG] Initial modal animation classes applied."); 
            } else { // If re-shown, just ensure it's visible (styles might be directly set if needed)
                // This path might not be hit if we always hide/show with animations.
                // We removed initial opacity-0 from HTML, so these should be visible by default
                // once 'hidden' is removed from userSetupModal. The animation classes will then take over.
                console.log("[DEBUG] Modal shown (not initial) - relying on default visibility + animation classes.");
            }
            chatAppContainer.classList.add('hidden'); 
            console.log("[DEBUG] chatAppContainer 'hidden' class added. Current classes:", chatAppContainer.className); 
            console.log("[DEBUG] showUserSetupModal finished.");
        }

        function hideUserSetupModal() {
            console.log("[DEBUG] hideUserSetupModal called"); 
            if (!userSetupModal || !userSetupModalBackdrop || !userSetupModalContent || !chatAppContainer || !chatApp || !messageInput) {
                console.error("[DEBUG] CRITICAL: One or more modal/app elements not found in hideUserSetupModal!");
                return;
            }

            userSetupModalBackdrop.classList.remove('modal-bg-enter', 'modal-bg-enter-active');
            userSetupModalBackdrop.classList.add('modal-bg-leave-active');
            
            userSetupModalContent.classList.remove('modal-content-enter', 'modal-content-enter-active');
            userSetupModalContent.classList.add('modal-content-leave-active');
            console.log("[DEBUG] Modal leave animation classes applied."); 

            setTimeout(() => {
                console.log("[DEBUG] setTimeout in hideUserSetupModal triggered."); 
                userSetupModal.classList.add('hidden'); // Add hidden back AFTER animation
                chatAppContainer.classList.remove('hidden'); 
                chatAppContainer.classList.add('flex');      
                chatApp.classList.add('app-loaded');         
                console.log("[DEBUG] Main app shown, app-loaded class added."); 
                setTimeout(() => {
                    if(messageInput) {
                         messageInput.focus();
                         console.log("[DEBUG] Message input focused."); 
                    } else {
                        console.error("[DEBUG] messageInput is null in hideUserSetupModal's inner setTimeout!");
                    }
                }, 50); 
            }, 300); // Match modal animation duration
            console.log("[DEBUG] hideUserSetupModal finished.");
        }
        
        // --- Message Handling ---
        function renderMessages() { /* ... */ }
        async function handleSendMessage() { /* ... */ }
        function addMessageToLocalListAndUI(msg, animate = true) { /* ... */ }
        function addSystemMessage(text) { /* ... */ }

        // --- UI Updates (Messages, User List, Typing) ---
        function formatTimestamp(isoTimestamp, timezone = 'Europe/Bucharest') { /* ... */ }
        function createMessageElement(msg) { /* ... */ }
        function addMessageToUI(msg, animate = true, isInitialLoad = false) { /* ... */ }
        function scrollToBottom() { /* ... */ }
        function readFileAsDataURL(file) { /* ... */ }
        attachFileButtonTrigger.addEventListener('click', () => imageFileInput.click());
        imageFileInput.addEventListener('change', async (e) => { /* ... */ });
        function showImagePreview(src) { /* ... */ }
        function closeImagePreview() { /* ... */ }
        closeImagePreviewButton.addEventListener('click', closeImagePreview);
        imagePreviewModalFullImgBackdrop.addEventListener('click', closeImagePreview);
        // function applyTheme(theme) { /* MOVED INTO DEBUG VERSION ABOVE */ }
        function toggleTheme() { /* ... */ }
        function loadThemePreference() { return localStorage.getItem(THEME_KEY) || 'dark'; }
        themeToggleButton.addEventListener('click', toggleTheme);

        // --- User List & Typing Indicator ---
        function renderUserList() { /* ... */ }
        function updateTypingIndicator() { /* ... */ }
        messageInput.addEventListener('input', () => { /* ... */ });
        toggleUserListButton.addEventListener('click', () => userListSidebar.classList.toggle('open'));

        // --- Emoji Picker ---
        const emojis = { /* ... same as before ... */ };
        function renderEmojiPicker(searchTerm = "") { /* ... same as before ... */ }
        function setupEmojiPicker() { /* ... same as before ... */ }

        // --- Event Listeners & Init ---
        sendMessageButton.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }});
        
        window.onload = initializeApp; 
        window.onbeforeunload = () => { /* ... */ };

        // Ensure all DOM element variables are defined after the DOM is loaded
        // or ensure they are only accessed within functions called after window.onload
        // The current structure with them as global consts should be fine as long as
        // they are only *used* in functions called by/after initializeApp.
    </script>
</body>
</html>
