<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chromachat - real-time (ref fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@300;400;500;700&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script> 
    <style>
        :root {
            --accent-color: #4caf50; --accent-color-dark: #388e3c;
            --text-primary-light: #212121; --text-secondary-light: #757575;
            --bg-light-light: #f5f5f5; --bg-default-light: #ffffff; --divider-color-light: #e0e0e0;
            
            --text-primary-dark: #f3f4f6; --text-secondary-dark: #9ca3af; 
            --bg-light-dark: #1f2937; --bg-default-dark: #374151; --divider-color-dark: #4b5563; 

            --error-color: #ef4444;
            --error-color-dark: #f87171;

            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --bg-light: var(--bg-light-light);
            --bg-default: var(--bg-default-light);
            --divider-color: var(--divider-color-light);
            --current-error-color: var(--error-color);
        }
        body {
            font-family: 'Roboto Mono', 'Noto Color Emoji', monospace; 
            background-color: var(--bg-light); color: var(--text-primary);
            overscroll-behavior-y: contain; text-transform: lowercase;
            display: flex; flex-direction: column; height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }
        #messageInput, .message-bubble p, #emojiSearchInput { 
            font-family: 'Roboto', 'Noto Color Emoji', sans-serif; 
            text-transform: none; 
        }
        .username-display, .user-list-item span, .typing-text, .button-text, label, #typingIndicatorArea, .emoji-category-title {
             font-family: 'Roboto Mono', 'Noto Color Emoji', monospace; 
        }
        #setupError { color: var(--current-error-color); min-height: 1.25rem; transition: color 0.3s ease; }


        .material-icons, .material-icons-outlined { vertical-align: middle; }
        .bg-accent { background-color: var(--accent-color); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        .ring-accent:focus { ring-color: var(--accent-color); }

        header, footer, #userListSidebar, #userSetupModalContent, #emojiPicker, .message-bubble {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .message-bubble.received, #userSetupModalContent, #emojiPicker {
             border: 1px solid var(--divider-color); 
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-light); border-radius: 10px; transition: background-color 0.3s ease; }
        ::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 10px; transition: background-color 0.3s ease;}
        ::-webkit-scrollbar-thumb:hover { background: #9e9e9e; }

        .ripple { /* ... */ }
        .chat-input:focus { /* ... */ }
        .message-item { /* ... */ }
        .message-item.sent-animation { /* ... */ }
        .message-item.received-animation { /* ... */ }
        .message-item.system-animation { /* ... */ }
        .message-item.show { /* ... */ }
        .message-bubble { /* ... */ }
        .message-bubble.sent { /* ... */ }
        .message-bubble.received { /* ... */ }
        .message-bubble.system { /* ... */ }
        .message-avatar, #currentUserAvatar, .user-list-item img { /* ... */ }
        .message-avatar:hover, #currentUserAvatar:hover, .user-list-item img:hover { /* ... */ }
        #currentUserAvatar { /* ... */ }
        .user-list-item img { /* ... */ }
        .message-image { /* ... */ }
        .message-image:hover { /* ... */ }
        .modal-bg-enter { /* ... */ }
        .modal-bg-enter-active { /* ... */ }
        .modal-bg-leave-active { /* ... */ }
        .modal-content-enter { /* ... */ }
        .modal-content-enter-active { /* ... */ }
        .modal-content-leave-active { /* ... */ }
        #imagePreviewModal { /* ... */ }
        #imagePreviewModal img { /* ... */ }
        .file-input-button { /* ... */ }
        .file-input-button:hover { /* ... */ }
        .loader { /* ... */ }
        .button-loader { /* ... */ }
        .attach-loader { /* ... */ }
        @keyframes spin { /* ... */ }
        
        .dark {
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --bg-light: var(--bg-light-dark);
            --bg-default: var(--bg-default-dark);
            --divider-color: var(--divider-color-dark);
            --current-error-color: var(--error-color-dark);
        }
        .dark ::-webkit-scrollbar-track { background: var(--bg-default-dark); }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .dark .message-avatar, .dark #currentUserAvatar, .dark .user-list-item img { border-color: var(--bg-light-dark); }
        
        #connectionStatus { /* ... */ }
        #connectionStatus.visible { /* ... */ }
        #connectionStatus.connected { /* ... */ }
        #connectionStatus.disconnected { /* ... */ }
        #connectionStatus.connecting { /* ... */ }

        #chatAppContainer.hidden-app { opacity: 0; transform: scale(0.95); pointer-events: none; }
        #chatAppContainer {
            opacity: 1; transform: scale(1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: auto;
        }
        #chatAppContainer { display: flex; flex: 1; overflow: hidden; }
        #chatApp > header { /* ... */ }
        #chatApp > footer { /* ... */ }
        #chatApp.app-loaded > header, #chatApp.app-loaded > footer { /* ... */ }

        #profilePicPreview { 
            transition: opacity 0.4s ease-in-out, transform 0.3s ease; 
            background-color: var(--divider-color);
        }
        #profilePicPreview.loading { /* ... */ }

        #themeToggleButton, #attachFileButtonWrapper > button, #sendMessageButton > span.material-icons, #emojiButton { /* ... */ }
        #themeToggleButton:hover, #attachFileButtonWrapper > button:hover, #sendMessageButton:hover > span.material-icons, #emojiButton:hover { /* ... */ }

        #userListSidebar { /* ... */ }
        #userListSidebar.open { /* ... */ }
        .user-list-item { /* ... */ }
        .user-list-item:hover { /* ... */ }
        .online-dot { /* ... */ }
        .typing-text { /* ... */ }
        #emojiPicker { /* ... */ }
        #emojiPicker.visible { /* ... */ }
        .emoji-category { /* ... */ }
        .emoji-category-title { /* ... */ }
        .emoji-grid { /* ... */ }
        .emoji-item { /* ... */ }
        .emoji-item:hover { /* ... */ }
        #emojiSearchInput { /* ... */ }
        .name-change-input { /* ... */ }
        .name-change-input:focus { /* ... */ }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden"> 
    <div id="connectionStatus">disconnected</div>

    <!-- Initial User Setup Modal -->
    <div id="userSetupModal" class="fixed inset-0 flex items-center justify-center z-50 p-4">
        <div id="userSetupModalBackdrop" class="absolute inset-0 bg-gray-900"></div>
        <div id="userSetupModalContent" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md transform">
             <div class="text-center">
                <span class="material-icons-outlined text-5xl text-accent mb-3">groups</span>
                <h2 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-gray-100">welcome to chromachat!</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-6">let's get you set up.</p>
            </div>
            <div class="space-y-5">
                <div>
                    <label for="usernameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">choose a nickname</label>
                    <div class="relative">
                        <span class="material-icons-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500">person_outline</span>
                        <input type="text" id="usernameInput" placeholder="e.g., chattycathy" class="w-full pl-10 pr-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 ring-accent focus:border-accent transition duration-150 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">profile picture (optional)</label>
                    <div class="flex items-center space-x-3">
                        <img id="profilePicPreview" src="https://placehold.co/80x80/374151/f3f4f6?text=avatar" alt="avatar preview" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600">
                        <label for="profilePicInput" class="file-input-button flex items-center space-x-2">
                            <span class="material-icons-outlined text-lg">upload_file</span>
                            <span>choose file</span>
                        </label>
                        <input type="file" id="profilePicInput" accept="image/png, image/jpeg, image/webp, image/gif" class="hidden" aria-label="profile picture file input">
                    </div>
                     <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">png, jpg, gif, webp. max 1mb.</p>
                </div>
            </div>
            <button id="joinChatButton" class="w-full bg-accent text-white py-3 mt-8 rounded-lg font-semibold ripple focus:outline-none focus:ring-2 focus:ring-offset-2 ring-accent transition duration-150 text-lg flex items-center justify-center space-x-2" aria-label="start chatting">
                <span class="material-icons-outlined default-icon">chat</span>
                <span class="button-text">start chatting</span>
                <div class="loader button-loader hidden"></div>
            </button>
            <p id="setupError" class="text-sm mt-3 text-center"></p>
        </div>
    </div>
    
    <div id="chatAppContainer" class="hidden-app flex-1"> 
        <aside id="userListSidebar" class="flex-col p-3 space-y-2 overflow-y-auto">
            <div class="flex items-center justify-between mb-2 sticky top-0 bg-inherit py-1">
                <h3 class="text-lg font-semibold text-accent">online users</h3>
                <span id="onlineUserCountBadge" class="text-xs bg-accent text-white px-1.5 py-0.5 rounded-full">0</span>
            </div>
            <div id="userList" class="space-y-1.5">
            </div>
        </aside>
        <main id="chatApp" class="flex flex-1 flex-col h-full overflow-hidden">
            <header class="bg-white dark:bg-gray-800 border-b border-divider-color dark:border-l dark:border-gray-700 p-3 sm:p-4 flex items-center justify-between shadow-sm">
                <div class="flex items-center">
                     <button id="toggleUserListButton" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none mr-2" aria-label="toggle user list">
                        <span class="material-icons-outlined text-gray-600 dark:text-gray-300">menu</span>
                    </button>
                    <h1 class="text-xl sm:text-2xl font-semibold text-accent flex items-center">
                        <span class="material-icons-outlined mr-2 text-3xl">forum</span>
                        chromachat
                    </h1>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="themeToggleButton" title="toggle theme" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none" aria-label="toggle theme">
                        <span class="material-icons-outlined text-gray-600 dark:text-gray-300">brightness_6</span>
                    </button>
                    <img id="currentUserAvatar" src="https://placehold.co/40x40/374151/f3f4f6?text=me" alt="my avatar" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover cursor-pointer border-2 border-accent">
                </div>
            </header>
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900" aria-live="polite">
            </div>
            <div id="typingIndicatorArea" class="h-6 px-4 pb-1 text-sm text-gray-500 dark:text-gray-400 flex items-center">
            </div>
            <footer class="bg-white dark:bg-gray-800 border-t border-divider-color dark:border-l dark:border-gray-700 p-3 sm:p-4 relative">
                 <div id="emojiPicker" class="hidden">
                    <input type="text" id="emojiSearchInput" placeholder="search emojis..." class="focus:ring-accent focus:border-accent">
                    <div id="emojiGridContainer"></div>
                 </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <button id="emojiButton" title="emojis" class="p-2.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-500 dark:text-gray-400" aria-label="select emoji">
                        <span class="material-icons-outlined text-2xl">sentiment_satisfied</span>
                    </button>
                    <div id="attachFileButtonWrapper" class="relative">
                        <button id="attachFileButtonTrigger" title="attach image" class="p-2.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-accent" aria-label="attach image">
                            <span class="material-icons-outlined text-2xl">attach_file</span>
                        </button>
                        <div id="attachFileLoader" class="loader attach-loader absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden"></div>
                    </div>
                    <input type="file" id="imageFileInput" accept="image/png, image/jpeg, image/webp, image/gif" class="hidden" aria-label="image file input">
                    <input type="text" id="messageInput" placeholder="type a message..." class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none chat-input transition duration-150 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" aria-label="message input">
                    <button id="sendMessageButton" class="bg-accent text-white rounded-full p-3 ripple focus:outline-none focus:ring-2 focus:ring-offset-1 ring-accent transition duration-150" aria-label="send message">
                        <span class="material-icons text-2xl">send</span>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <div id="imagePreviewModal" class="fixed inset-0 flex items-center justify-center z-50 p-4 hidden">
        <div id="imagePreviewModalBackdrop" class="absolute inset-0 bg-black"></div>
        <img id="fullScreenImage" src="" alt="full screen preview" class="max-w-full max-h-full rounded-lg shadow-xl z-10 transform">
        <button id="closeImagePreviewButton" class="absolute top-4 right-4 text-white text-3xl z-20 p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75" aria-label="close image preview">
            <span class="material-icons">close</span>
        </button>
    </div>

    <script>
        // DOM Elements 
        const userSetupModal = document.getElementById('userSetupModal');
        const userSetupModalBackdrop = document.getElementById('userSetupModalBackdrop');
        const userSetupModalContent = document.getElementById('userSetupModalContent');
        const usernameInput = document.getElementById('usernameInput');
        const profilePicInput = document.getElementById('profilePicInput');
        const profilePicPreview = document.getElementById('profilePicPreview');
        const joinChatButton = document.getElementById('joinChatButton');
        const joinChatButtonDefaultIcon = joinChatButton.querySelector('.default-icon');
        const joinChatButtonText = joinChatButton.querySelector('.button-text');
        const joinChatButtonLoader = joinChatButton.querySelector('.button-loader');
        const setupError = document.getElementById('setupError');
        
        const chatAppContainer = document.getElementById('chatAppContainer');
        const chatApp = document.getElementById('chatApp'); 
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const connectionStatusDiv = document.getElementById('connectionStatus');
        const userListSidebar = document.getElementById('userListSidebar');
        const userListDiv = document.getElementById('userList');
        const onlineUserCountBadge = document.getElementById('onlineUserCountBadge');
        const toggleUserListButton = document.getElementById('toggleUserListButton');
        const typingIndicatorArea = document.getElementById('typingIndicatorArea');

        const attachFileButtonWrapper = document.getElementById('attachFileButtonWrapper');
        const attachFileButtonTrigger = document.getElementById('attachFileButtonTrigger');
        const attachFileLoader = document.getElementById('attachFileLoader');
        const imageFileInput = document.getElementById('imageFileInput');

        const imagePreviewModal = document.getElementById('imagePreviewModal');
        const imagePreviewModalFullImg = document.getElementById('fullScreenImage');
        const imagePreviewModalFullImgBackdrop = document.getElementById('imagePreviewModalBackdrop');
        const closeImagePreviewButton = document.getElementById('closeImagePreviewButton');
        const themeToggleButton = document.getElementById('themeToggleButton');

        const emojiButton = document.getElementById('emojiButton');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGridContainer = document.getElementById('emojiGridContainer');
        const emojiSearchInput = document.getElementById('emojiSearchInput');

        // --- State ---
        let userProfile = { /* ... */ };
        let messages = []; 
        let tempImageFileDataUrl = null; 
        let socket = null; 
        const SERVER_URL = 'https://chromachat-server.onrender.com'; 
        let notificationSound = null;
        let typingTimeout = null;
        let onlineUsers = {}; 

        const THEME_KEY = 'chromaChatThemePreference';
        
        // --- Function Definitions ---
        function initializeSounds() { /* ... */ }
        function playNotificationSound() { /* ... */ }
        function requestNotificationPermission() { /* ... */ }
        function showNotification(title, body, icon) { /* ... */ }
        function updateConnectionStatus(status, message = '') { /* ... */ }
        function connectToServer() { /* ... */ }
        
        // --- Theme Management ---
        // ADDED loadThemePreference function
        function loadThemePreference() {
            return localStorage.getItem(THEME_KEY) || 'dark'; // Default to dark
        }

        function applyTheme(theme) {
            // console.log("[DEBUG] applyTheme called with theme:", theme); 
            const themeIconElement = document.getElementById('themeToggleButton');
            const icon = themeIconElement ? themeIconElement.querySelector('.material-icons-outlined') : null;

            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                if (icon) icon.textContent = 'light_mode';
            } else {
                document.documentElement.classList.remove('dark');
                if (icon) icon.textContent = 'brightness_6';
            }
            // console.log("[DEBUG] Theme class on <html> updated.");
            const avatarPlaceholderColor = theme === 'dark' ? '374151/f3f4f6' : 'E0E0E0/757575';
            if (profilePicPreview && profilePicPreview.src.includes('placehold.co')) {
                profilePicPreview.src = `https://placehold.co/80x80/${avatarPlaceholderColor}?text=avatar`;
            }
            if (currentUserAvatar && currentUserAvatar.src.includes('placehold.co')) {
                 if (!userProfile.username || !userProfile.profilePicDataUrl.startsWith('data:image') && !userProfile.profilePicDataUrl.startsWith('https://ui-avatars.com')) {
                     currentUserAvatar.src = `https://placehold.co/40x40/${avatarPlaceholderColor}?text=me`;
                 }
            }
            // console.log("[DEBUG] Theme application finished.");
        }
        function toggleTheme() {
            let newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme); 
            localStorage.setItem(THEME_KEY, newTheme);
        }


        async function handleJoinChat() { /* ... same as previous version with fixes */ }
        function resetJoinButton() { /* ... same as previous version */ }
        function showUserSetupModal(initial = false) { /* ... same as previous version with fixes ... */ }
        function hideUserSetupModal() { /* ... same as previous version with fixes ... */ }
        function renderMessages() { /* ... */ }
        async function handleSendMessage() { /* ... */ }
        function addMessageToLocalListAndUI(msg, animate = true) { /* ... */ }
        function addSystemMessage(text) { /* ... */ }
        function formatTimestamp(isoTimestamp, timezone = 'Europe/Bucharest') { /* ... */ }
        function createMessageElement(msg) { /* ... */ }
        function addMessageToUI(msg, animate = true, isInitialLoad = false) { /* ... */ }
        function scrollToBottom() { /* ... */ }
        function readFileAsDataURL(file) { /* ... */ }
        function showImagePreview(src) { /* ... */ }
        function closeImagePreview() { /* ... */ }
        function renderUserList() { /* ... */ }
        function updateTypingIndicator() { /* ... */ }
        const emojis = { /* ... */ };
        function renderEmojiPicker(searchTerm = "") { /* ... */ }
        function setupEmojiPicker() { /* ... */ }
        function handleChangeName(userId, currentUsername) { /* ... (from previous polish step) ... */ }


        // --- App Initialization ---
        function initializeApp() {
            console.log("[DEBUG] Script execution started. Attempting to initialize app..."); 
            
            applyTheme(loadThemePreference()); // loadThemePreference is now defined
            console.log("[DEBUG] Theme applied."); 
            initializeSounds();
            console.log("[DEBUG] Sounds initialized."); 
            requestNotificationPermission();
            console.log("[DEBUG] Notification permission requested."); 

            if (userProfile.username && userProfile.id) { 
                console.log("[DEBUG] User profile found, showing main chat."); 
                if(currentUserAvatar) currentUserAvatar.src = userProfile.profilePicDataUrl;
                hideUserSetupModal();
                connectToServer(); 
            } else {
                console.log("[DEBUG] No complete user profile, showing setup modal."); 
                showUserSetupModal(true); 
            }
            console.log("[DEBUG] Setting up emoji picker."); 
            setupEmojiPicker();

            console.log("[DEBUG] Attaching global event listeners.");
            if (profilePicInput) profilePicInput.addEventListener('change', async (e) => { /* ... */ });
            if (joinChatButton) joinChatButton.addEventListener('click', async () => { if (await handleJoinChat()) hideUserSetupModal(); });
            if (attachFileButtonTrigger) attachFileButtonTrigger.addEventListener('click', () => imageFileInput.click());
            if (imageFileInput) imageFileInput.addEventListener('change', async (e) => { /* ... */ });
            if (closeImagePreviewButton) closeImagePreviewButton.addEventListener('click', closeImagePreview);
            if (imagePreviewModalFullImgBackdrop) imagePreviewModalFullImgBackdrop.addEventListener('click', closeImagePreview);
            if (themeToggleButton) themeToggleButton.addEventListener('click', toggleTheme);
            if (sendMessageButton) sendMessageButton.addEventListener('click', handleSendMessage);
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }});
                messageInput.addEventListener('input', () => { /* ... */ });
            }
            if (toggleUserListButton) toggleUserListButton.addEventListener('click', () => userListSidebar.classList.toggle('open'));
            
            console.log("[DEBUG] App initialization complete."); 
        }
        
        window.onload = initializeApp; 
        window.onbeforeunload = () => { /* ... */ };
    </script>
</body>
</html>
```

**Key Changes in this Version:**

1.  **`loadThemePreference()` Function Added Back:**
    * I've re-inserted the `loadThemePreference` function. It should be defined *before* `applyTheme` or `initializeApp` is called.

    ```javascript
    function loadThemePreference() {
        return localStorage.getItem(THEME_KEY) || 'dark'; // Default to dark
    }
    ```

With this function correctly in place, `applyTheme(loadThemePreference())` inside `initializeApp` should no longer cause a `ReferenceError`.

Please deploy this and let's see if the modal appears and the rest of the initialization procee
